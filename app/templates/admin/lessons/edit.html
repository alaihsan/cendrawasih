{% extends "base.html" %}

{% block title %}Edit Pelajaran - Cendrawasih{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="fade-in">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Edit Pelajaran</h1>
            <p class="text-gray-600 mt-2">{{ lesson.title }}</p>
        </div>
        
        <!-- Form -->
        <div class="bg-white rounded-lg shadow-md p-8">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {{ form.hidden_tag() }}
                
                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-semibold text-gray-900 mb-2">Judul Pelajaran</label>
                    {{ form.title(class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500") }}
                </div>
                
                <!-- Content Type -->
                <div>
                    <label for="content_type" class="block text-sm font-semibold text-gray-900 mb-2">Tipe Konten</label>
                    {{ form.content_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500", onchange="updateContentFields()") }}
                </div>
                
                <!-- Content URL (for video_url/pdf) -->
                <div id="url-field" class="hidden">
                    <label for="content_url" class="block text-sm font-semibold text-gray-900 mb-2">URL Konten</label>
                    <p class="text-gray-600 text-sm mb-2">Contoh: https://www.youtube.com/embed/..., https://example.com/file.pdf</p>
                    {{ form.content_url(class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500", placeholder="https://...") }}
                </div>

                <!-- Video File Upload -->
                <div id="video-upload-field" class="hidden">
                    <label for="video_file" class="block text-sm font-semibold text-gray-900 mb-2">
                        <i class="fas fa-video text-emerald-600 mr-2"></i>Unggah Video / Ganti Video
                    </label>
                    <div class="border-2 border-dashed border-emerald-300 rounded-lg p-6 text-center bg-emerald-50">
                        {{ form.video_file(class="", accept="video/*") }}
                        <p class="text-sm text-gray-600 mt-2">Format: MP4, WebM, AVI, MOV (Maks 100MB)</p>
                        <p class="text-xs text-emerald-600 mt-1">Video akan dikompresi otomatis ke multiple quality!</p>
                        {% if lesson.compressed_video_versions %}
                            <p class="text-xs text-gray-500 mt-2">Video saat ini: Tersedia dalam 4 quality level</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Image/Thumbnail Upload -->
                <div>
                    <label for="image_file" class="block text-sm font-semibold text-gray-900 mb-2">
                        <i class="fas fa-image text-blue-600 mr-2"></i>Unggah Gambar/Thumbnail (Opsional)
                    </label>
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center bg-blue-50">
                        {{ form.image_file(class="", accept="image/*") }}
                        <p class="text-sm text-gray-600 mt-2">Format: JPG, PNG, WebP, GIF</p>
                        <p class="text-xs text-blue-600 mt-1">Gambar akan dikompresi otomatis!</p>
                        {% if lesson.compressed_image %}
                            <p class="text-xs text-gray-500 mt-2">Gambar saat ini: {{ lesson.compressed_image }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Text Content (for text) -->
                <div id="text-field" class="hidden">
                    <label for="text_content" class="block text-sm font-semibold text-gray-900 mb-2">Konten Teks</label>
                    {{ form.text_content(class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none", rows="8") }}
                </div>
                
                <!-- Order -->
                <div>
                    <label for="order" class="block text-sm font-semibold text-gray-900 mb-2">Urutan</label>
                    {{ form.order(class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500", type="number") }}
                </div>
                
                <!-- Buttons -->
                <div class="flex gap-4 pt-4">
                    {{ form.submit(class="flex-1 bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition font-semibold", value="Simpan") }}
                    <a href="{{ url_for('admin.course_detail', course_id=lesson.topic.course_id) }}" class="flex-1 text-center bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                        Batal
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateContentFields() {
    const contentType = document.querySelector('select[name="content_type"]').value;
    const urlField = document.getElementById('url-field');
    const textField = document.getElementById('text-field');
    const videoUploadField = document.getElementById('video-upload-field');
    
    // Hide all first
    urlField.classList.add('hidden');
    textField.classList.add('hidden');
    videoUploadField.classList.add('hidden');
    
    // Show based on content type
    if (contentType === 'text') {
        textField.classList.remove('hidden');
    } else if (contentType === 'video') {
        // Local video upload
        videoUploadField.classList.remove('hidden');
    } else if (contentType === 'video_url' || contentType === 'pdf') {
        // YouTube embed or PDF link
        urlField.classList.remove('hidden');
    }
}

// Handle file selection preview
function handleFileSelect(event, fieldType) {
    const files = event.target.files;
    if (files && files.length > 0) {
        const file = files[0];
        const fileSize = (file.size / (1024 * 1024)).toFixed(2); // MB
        
        let message = '';
        if (fieldType === 'video') {
            message = `Video dipilih: ${file.name} (${fileSize}MB) - Akan dikompresi ke multiple quality otomatis!`;
        } else if (fieldType === 'image') {
            message = `Gambar dipilih: ${file.name} (${fileSize}MB) - Akan dikompresi otomatis!`;
        }
        
        if (message) {
            console.log(message);
        }
    }
}

// Add event listeners for file inputs
document.addEventListener('DOMContentLoaded', function() {
    updateContentFields();
    
    const videoInput = document.querySelector('input[name="video_file"]');
    const imageInput = document.querySelector('input[name="image_file"]');
    
    if (videoInput) {
        videoInput.addEventListener('change', function(e) {
            handleFileSelect(e, 'video');
        });
    }
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            handleFileSelect(e, 'image');
        });
    }
});
</script>
{% endblock %}
